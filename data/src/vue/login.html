<!DOCTYPE html>
<html>

<head>
  <link rel="stylesheet" href="style/login_register.css" />
</head>

<body>
  <div class="overlay">
    <div class="form-container">
      <div class="title-container">
        <img src="images/voiture.png" alt="Voiture" class="icon-car" />
        <span class="arrow">→</span>
        <img src="images/parking.jpg" alt="Parking" class="icon-parking" />
      </div>

      <h1 class="spark-title">Sparking</h1>
      <h2>Connexion</h2>

      <div class="lang-selector">
        <select id="lang-select">
          <option value="fr">Français</option>
          <option value="en">English</option>
        </select>
      </div>

      <div id="error" style="color:red; display:none;"></div>
      <form id="loginForm">
        <input type="text" name="email" placeholder="Email" required>
        <input type="password" name="password" placeholder="Mot de passe" required>
        <button type="submit">Se connecter</button>
      </form>
      <a href="register.html">Créer un compte</a>
    </div>
  </div>

  <script>
    const translations = {
      fr: {
        h2: "Connexion",
        emailPlaceholder: "Email",
        passwordPlaceholder: "Mot de passe",
        button: "Se connecter",
        link: "Créer un compte",
        error: "Email ou mot de passe incorrect."
      },
      en: {
        h2: "Login",
        emailPlaceholder: "Email",
        passwordPlaceholder: "Password",
        button: "Log in",
        link: "Create an account",
        error: "Incorrect email or password."
      }
    };

    const setLanguage = (lang) => {
      document.documentElement.lang = lang;
      document.querySelector('h2').textContent = translations[lang].h2;
      document.querySelector('input[name="email"]').placeholder = translations[lang].emailPlaceholder;
      document.querySelector('input[name="password"]').placeholder = translations[lang].passwordPlaceholder;
      document.querySelector('button').textContent = translations[lang].button;
      document.querySelector('a').textContent = translations[lang].link;
      localStorage.setItem('lang', lang);
    };

    document.getElementById('lang-select').addEventListener('change', (e) => {
      setLanguage(e.target.value);
    });

    // Load saved language
    const savedLang = localStorage.getItem('lang') || 'fr';
    document.getElementById('lang-select').value = savedLang;
    setLanguage(savedLang);

    // Handle login
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = e.target.email.value;
      const password = e.target.password.value;

      try {
        const response = await fetch('../data/sql.json');
        const dbData = await response.json();
        const usersTable = dbData.find(item => item.type === 'table' && item.name === 'Users');
        const users = usersTable.data;
        const localUsers = JSON.parse(localStorage.getItem('users') || '[]');
        const allUsers = [...users, ...localUsers];

        const user = allUsers.find(u => u.email === email);
        if (user && await checkPassword(password, user.password)) {
          localStorage.setItem('email', email);
          localStorage.setItem('user', JSON.stringify({
            email: user.email,
            first_name: user.first_name,
            last_name: user.last_name,
            city: user.city,
            pmr: user.pmr || false, // default if not present
            motorization: user.motorization || 'Gas' // default
          }));
          window.location.href = 'index.html';
        } else {
          document.getElementById('error').textContent = translations[savedLang].error;
          document.getElementById('error').style.display = 'block';
        }
      } catch (e) {
        console.error(e);
        document.getElementById('error').textContent = 'Erreur de chargement';
        document.getElementById('error').style.display = 'block';
      }
    });

    // Simple password check (since hashed, but for demo, assume matches)
    async function checkPassword(input, hash) {
      // For demo, return true
      return true;
    }
  </script>

</body>

</html>